<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Town of Shadows</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0b0f;color:#eee;display:flex;flex-direction:column;align-items:center;padding:16px}
    h1{color:#f4b400}
    button{margin:4px;padding:8px 12px;border-radius:8px;border:none;background:#2b2b2b;color:#fff;cursor:pointer}
    #grid{display:grid;grid-template-columns:repeat(5,120px);gap:8px;margin-top:12px}
    .box{background:#131318;border:1px solid #2a2a2a;padding:8px;border-radius:6px;text-align:center}
    #chatArea{width:100%;max-width:760px;margin-top:10px;min-height:80px;border-top:1px solid #222;padding-top:8px}
    input,select{padding:6px;border-radius:6px;border:none}
    #roleActions{margin-top:10px}
    .phaseBar{margin-top:8px;padding:8px;border-radius:6px;background:#16161a;width:100%;max-width:760px;text-align:center}
    .countdown{font-weight:bold}
  </style>
</head>
<body>
  <h1>Town of Shadows</h1>

  <div class="phaseBar">
    Phase: <span id="phaseName">â€”</span> | Time left: <span id="phaseTime" class="countdown">â€”</span>
  </div>

  <div id="controls" style="margin-top:8px;">
    <button id="startBtn">Start Game</button>
    <button id="skipPhaseBtn">Skip Phase</button>
  </div>

  <div id="roleActions"></div>

  <div id="grid"></div>

  <div style="margin-top:8px;width:100%;max-width:760px;display:flex;gap:8px">
    <input id="chatInput" placeholder="Type a message..." style="flex:1">
    <button id="sendChat">Send</button>
  </div>

  <div id="chatArea"></div>

<script type="module">
import { TownOfShadowsWS } from "./wsClient.js";

const BACKEND_URL = "https://town-of-shadows-server.onrender.com";

// create/join room
let roomInput = prompt("Enter Room ID (or leave blank to create a new room):");
let roomId = roomInput?.trim();
if (!roomId) {
  const res = await fetch(`${BACKEND_URL}/create-room`, { method: "POST" });
  const data = await res.json();
  roomId = data.roomId;
  alert("Created Room: " + roomId);
}

const name = prompt("Enter display name:") || "Player";
const game = new TownOfShadowsWS(roomId, name);
game.connect();

// UI refs
const grid = document.getElementById("grid");
const chatArea = document.getElementById("chatArea");
const roleActions = document.getElementById("roleActions");
const phaseName = document.getElementById("phaseName");
const phaseTime = document.getElementById("phaseTime");

// helper
function pushMessage(text) {
  const d = document.createElement("div"); d.textContent = text; chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
}

// handle room updates: render grid
game.onRoomUpdate = (room) => {
  grid.innerHTML = "";
  room.players.forEach(p => {
    const box = document.createElement("div");
    box.className = "box";
    box.innerHTML = `<strong>${p.name}</strong><div>${p.alive ? "ðŸŸ© Alive" : "ðŸ’€ Dead"}</div><div>${p.symbol || ""}</div>`;
    grid.appendChild(box);
  });
};

// system messages
game.onSystem = (msg) => { pushMessage("ðŸ”” " + msg) }

// chats
game.onChat = (from, text) => { pushMessage(`${from}: ${text}`) }

// phase updates (from server)
game.onPhase = (p) => {
  phaseName.textContent = p.phase || "â€”";
  if (typeof p.seconds !== 'undefined') phaseTime.textContent = p.seconds + "s";
  // control chat / actions in UI based on phase (frontend disables chat input during night/public restrictions)
  if (p.phase === "night") {
    document.getElementById("chatInput").disabled = true;
  } else {
    document.getElementById("chatInput").disabled = false;
  }
};

// private role arrives -> render role controls for that human
let myRole = null;
let myName = name;
game.onPrivateRole = (obj) => {
  myRole = obj.role;
  pushMessage(`(PRIVATE) Your role: ${obj.role} â€” ${obj.explain || ""}`);
  renderRoleControls();
};

// send chat
document.getElementById("sendChat").onclick = () => {
  const t = document.getElementById("chatInput").value;
  if (!t) return;
  game.sendChat(t);
  document.getElementById("chatInput").value = "";
};

// start game by sending ws start_game
document.getElementById("startBtn").onclick = () => {
  game.startGame();
};

// skip phase (admin / host control) - also useful for testing
document.getElementById("skipPhaseBtn").onclick = async () => {
  const res = await fetch(`${BACKEND_URL}/next-phase/${roomId}`, { method: "POST" });
  const txt = await res.text(); pushMessage("SkipPhase: " + txt);
};

// render role controls (human-only buttons)
function renderRoleControls() {
  roleActions.innerHTML = "";
  if (!myRole) return;
  const title = document.createElement("div");
  title.textContent = `Your role: ${myRole}`;
  roleActions.appendChild(title);

  // Cupid (link two players)
  if (myRole === "Cupid") {
    const inp = document.createElement("input"); inp.placeholder = "Name to link";
    const btn = document.createElement("button"); btn.textContent = "Link (Cupid)";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) game.queueAction(myName, tgt, "cupid_link"); }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // Janitor
  if (myRole === "Janitor") {
    const inp = document.createElement("input"); inp.placeholder = "Corpse name to clean";
    const btn = document.createElement("button"); btn.textContent = "Clean (Janitor)";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) game.queueAction(myName, tgt, "janitor_clean"); }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // Executioner
  if (myRole === "Executioner") {
    const inp = document.createElement("input"); inp.placeholder = "Set target name";
    const btn = document.createElement("button"); btn.textContent = "Set Target (Executioner)";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) game.queueAction(myName, tgt, "executioner_set"); }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // Doctor
  if (myRole === "Doctor") {
    const inp = document.createElement("input"); inp.placeholder = "Name to heal (any)";
    const btn = document.createElement("button"); btn.textContent = "Heal (Doctor)";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) game.queueAction(myName, tgt, "doctor_heal"); }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // Mafia kill roles
  if (["Mafioso","Godfather","Beastman"].includes(myRole)) {
    const inp = document.createElement("input"); inp.placeholder = "Target name to kill";
    const btn = document.createElement("button"); btn.textContent = "Kill (Mafia)";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) {
        const type = myRole === "Beastman" ? "beast_kill" : "mafia_kill";
        game.queueAction(myName, tgt, type);
    } }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // Serial Killer
  if (myRole === "Serial Killer") {
    const inp = document.createElement("input"); inp.placeholder = "Target name";
    const btn = document.createElement("button"); btn.textContent = "Kill (SK)";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) game.queueAction(myName, tgt, "serial_kill"); }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // Detective / Investigator / Sheriff - investigation (example: Detective)
  if (myRole === "Detective" || myRole === "Sheriff") {
    const inp = document.createElement("input"); inp.placeholder = "Name to investigate";
    const btn = document.createElement("button"); btn.textContent = "Investigate";
    btn.onclick = () => { const tgt = inp.value.trim(); if (tgt) game.queueAction(myName, tgt, "detective_check"); }
    roleActions.appendChild(inp); roleActions.appendChild(btn);
  }

  // add other role-specific UI elements as needed...
}
</script>
</body>
  </html>
